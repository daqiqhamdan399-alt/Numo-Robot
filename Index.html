<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Komunikasi ESP32</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4a6bff;
            --secondary: #6c42f5;
            --accent: #ff6b6b;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --background: #1a1a2e;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text: #e6e6e6;
            --border: rgba(255, 255, 255, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(to right, #0f0c29, #302b63, #24243e);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-attachment: fixed;
            overflow-x: auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, #ff6b6b, #4a6bff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        
        .connection-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            flex-wrap: wrap;
        }
        
        .ip-input {
            display: flex;
            align-items: center;
            flex: 1;
            margin-right: 15px;
            min-width: 250px;
        }
        
        .ip-input input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            font-size: 1rem;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin: 0 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected {
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .disconnected {
            background-color: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #6c757d, #5a6268);
        }
        
        .btn-success {
            background: linear-gradient(to right, var(--success), #20bf6b);
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger), #eb3b5a);
        }
        
        .btn-warning {
            background: linear-gradient(to right, var(--warning), #ff9a3d);
        }
        
        .btn-info {
            background: linear-gradient(to right, var(--info), #17a2b8);
        }
        
        .game-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .main-menu .game-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .main-btn {
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .main-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
        }
        
        .main-btn i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .main-btn span {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .screen {
            width: 100%;
            animation: fadeIn 0.5s ease;
        }
        
        .hidden {
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .game-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2rem;
            color: var(--primary);
        }
        
        .message {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 1.1rem;
        }
        
        /* Tic Tac Toe Styles */
        .tictactoe-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px auto;
            max-width: 350px;
        }
        
        .tictactoe-cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tictactoe-cell:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .tictactoe-cell.x {
            color: var(--accent);
        }
        
        .tictactoe-cell.o {
            color: var(--info);
        }
        
        .win-line {
            position: absolute;
            background: var(--accent);
            z-index: 1;
            height: 8px;
            border-radius: 4px;
        }
        
        /* Rock Paper Scissors Styles */
        .rps-options {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .rps-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .rps-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .rps-result {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            text-align: center;
        }
        
        .rps-choice {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .rps-choice i {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        /* Quiz Matematika Styles - Diperbarui */
        .quiz-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .question-display {
            font-size: 2.5rem;
            margin: 10px 0;
            min-height: 80px;
            text-align: center;
            font-weight: bold;
            color: var(--text);
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .answer-input {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            width: 100%;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .number-pad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 10px 0;
            max-width: 240px;
        }
        
        .number-btn {
            padding: 12px;
            font-size: 1.3rem;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
        }
        
        .number-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .input-display {
            font-size: 2rem;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-width: 120px;
            text-align: center;
            margin: 0 10px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .submit-btn {
            padding: 12px 20px;
            font-size: 1.1rem;
            margin-left: 10px;
            height: 60px;
        }
        
        .difficulty-buttons {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .timer {
            font-size: 1.8rem;
            text-align: center;
            margin: 10px 0;
            color: var(--accent);
            font-weight: bold;
        }
        
        .quiz-result {
            text-align: center;
            margin: 10px 0;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .result-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 500px;
            margin: 10px 0 20px 0;
        }
        
        .result-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-width: 130px;
        }
        
        .result-title {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--info);
        }
        
        .result-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .correct {
            color: var(--success);
        }
        
        .incorrect {
            color: var(--danger);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .simulation-panel {
            margin-top: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }
        
        .simulation-title {
            text-align: center;
            margin-bottom: 12px;
            color: var(--info);
        }
        
        .simulation-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .auto-simulate-btn {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
        }
        
        @media (max-width: 768px) {
            .game-grid {
                grid-template-columns: 1fr;
            }
            
            .main-menu .game-grid {
                grid-template-columns: 1fr;
            }
            
            .connection-panel {
                flex-direction: column;
            }
            
            .ip-input {
                margin-right: 0;
                margin-bottom: 15px;
                width: 100%;
            }
            
            .connection-status {
                margin: 10px 0;
            }
            
            .rps-options {
                flex-direction: row;
                align-items: center;
            }
            
            .difficulty-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .question-display {
                font-size: 2rem;
            }
            
            .result-container {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
            
            .number-pad {
                max-width: 220px;
            }
            
            .answer-input {
                flex-direction: column;
            }
            
            .submit-btn {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Game Komunikasi ESP32</h1>
        <p>Pilih game untuk berinteraksi dengan robot ESP32</p>
    </div>
    
    <div class="container">
        <div class="connection-panel">
            <div class="ip-input">
                <i class="fas fa-network-wired"></i>
                <input type="text" id="ipAddress" placeholder="Masukkan alamat IP ESP32" value="192.168.1.100">
            </div>
            
            <div class="connection-status">
                <span class="status-indicator disconnected" id="connectionStatus"></span>
                <span id="connectionText">Terputus</span>
            </div>
            
            <button class="btn btn-primary" onclick="connectWebSocket()">
                <i class="fas fa-plug"></i> Sambungkan
            </button>
            
            <button class="btn btn-secondary" onclick="disconnectWebSocket()">
                <i class="fas fa-power-off"></i> Putuskan
            </button>
        </div>
        
        <!-- Tampilan Utama -->
        <div id="mainScreen" class="screen">
            <div class="game-grid main-menu">
                <div class="main-btn" onclick="loadGame('tictactoe')">
                    <i class="fas fa-times"></i>
                    <span>Tic Tac Toe</span>
                </div>
                <div class="main-btn" onclick="loadGame('rps')">
                    <i class="fas fa-hand-rock"></i>
                    <span>Kertas Batu Gunting</span>
                </div>
                <div class="main-btn" onclick="loadGame('quiz')">
                    <i class="fas fa-calculator"></i>
                    <span>Kuis Matematika</span>
                </div>
            </div>
        </div>
        
        <!-- Tic Tac Toe -->
        <div id="tictactoeScreen" class="screen hidden">
            <h2 class="game-title">Tic Tac Toe</h2>
            
            <div class="message" id="tictactoeMessage">Pilih peran Anda</div>
            
            <div class="role-selection">
                <button class="btn btn-success" onclick="setPlayerRole('X')">
                    <i class="fas fa-user"></i> Saya X
                </button>
                <button class="btn btn-danger" onclick="setPlayerRole('O')">
                    <i class="fas fa-robot"></i> Saya O
                </button>
            </div>
            
            <div style="position: relative;">
                <div class="tictactoe-board" id="tictactoeBoard">
                    <!-- Kotak akan diisi oleh JavaScript -->
                </div>
                <div id="winLine"></div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="playTicTacToe()">
                    <i class="fas fa-play"></i> Play
                </button>
                <button class="btn btn-warning" onclick="resetTicTacToe()">
                    <i class="fas fa-redo"></i> Reset
                </button>
                <button class="btn btn-secondary" onclick="backToMain()">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
            </div>
            
            <div class="simulation-panel">
                <h3 class="simulation-title">Simulasi Otomatis</h3>
                <div class="simulation-buttons">
                    <button class="btn auto-simulate-btn" onclick="simulateTicTacToe()">
                        <i class="fas fa-robot"></i> Simulasi Tic Tac Toe
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Kertas Batu Gunting -->
        <div id="rpsScreen" class="screen hidden">
            <h2 class="game-title">Kertas Batu Gunting</h2>
            
            <div class="message" id="rpsMessage">Tekan Play untuk memulai</div>
            
            <div class="timer" id="rpsTimer">3</div>
            
            <div class="rps-options">
                <button class="rps-btn" onclick="selectRPS(1)">📄</button>
                <button class="rps-btn" onclick="selectRPS(2)">✊</button>
                <button class="rps-btn" onclick="selectRPS(3)">✂️</button>
            </div>
            
            <div class="rps-result">
                <div class="rps-choice">
                    <div>Anda</div>
                    <i id="playerChoiceIcon">-</i>
                    <div id="playerChoiceText">Belum memilih</div>
                </div>
                <div class="rps-choice">
                    <div>VS</div>
                </div>
                <div class="rps-choice">
                    <div>Robot</div>
                    <i id="robotChoiceIcon">-</i>
                    <div id="robotChoiceText">Belum memilih</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="playRPS()">
                    <i class="fas fa-play"></i> Play
                </button>
                <button class="btn btn-secondary" onclick="backToMain()">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
            </div>
            
            <div class="simulation-panel">
                <h3 class="simulation-title">Simulasi Otomatis</h3>
                <div class="simulation-buttons">
                    <button class="btn auto-simulate-btn" onclick="simulateRPS()">
                        <i class="fas fa-robot"></i> Simulasi Kertas Batu Gunting
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Kuis Matematika -->
        <div id="quizScreen" class="screen hidden">
            <h2 class="game-title">Kuis Matematika</h2>
            
            <div class="message" id="quizMessage">Pilih tingkat kesulitan dan tekan Play</div>
            
            <div class="difficulty-buttons">
                <button class="btn btn-success" id="easyBtn" onclick="setDifficulty('mudah')">
                    <i class="fas fa-smile"></i> Mudah (3 detik)
                </button>
                <button class="btn btn-warning" id="mediumBtn" onclick="setDifficulty('sedang')">
                    <i class="fas fa-meh"></i> Sedang (5 detik)
                </button>
                <button class="btn btn-danger" id="hardBtn" onclick="setDifficulty('susah')">
                    <i class="fas fa-frown"></i> Susah (8 detik)
                </button>
            </div>
            
            <div class="result-container">
                <div class="result-box">
                    <div class="result-title">Jawaban Robot</div>
                    <div class="result-value" id="robotAnswer">-</div>
                </div>
                <div class="result-box">
                    <div class="result-title">Hasil</div>
                    <div class="result-value" id="quizResult">-</div>
                </div>
            </div>
            
            <div class="quiz-container">
                <div class="question-display" id="questionDisplay">
                    Soal akan muncul di sini
                </div>
                
                <div class="timer" id="quizTimer">-</div>
                
                <div class="answer-input">
                    <div class="input-display" id="answerDisplay">0</div>
                    <button class="btn btn-primary submit-btn" onclick="submitAnswer()" id="submitAnswerBtn">
                        <i class="fas fa-paper-plane"></i> Jawab
                    </button>
                </div>
                
                <div class="number-pad">
                    <button class="number-btn" onclick="appendNumber(7)">7</button>
                    <button class="number-btn" onclick="appendNumber(8)">8</button>
                    <button class="number-btn" onclick="appendNumber(9)">9</button>
                    <button class="number-btn" onclick="deleteLast()">⌫</button>
                    <button class="number-btn" onclick="appendNumber(4)">4</button>
                    <button class="number-btn" onclick="appendNumber(5)">5</button>
                    <button class="number-btn" onclick="appendNumber(6)">6</button>
                    <button class="number-btn" onclick="clearAnswer()">C</button>
                    <button class="number-btn" onclick="appendNumber(1)">1</button>
                    <button class="number-btn" onclick="appendNumber(2)">2</button>
                    <button class="number-btn" onclick="appendNumber(3)">3</button>
                    <button class="number-btn" onclick="toggleNegative()">-</button>
                    <button class="number-btn" onclick="appendNumber(0)">0</button>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="playQuiz()">
                    <i class="fas fa-play"></i> Play
                </button>
                <button class="btn btn-secondary" onclick="backToMain()">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
            </div>
            
            <div class="simulation-panel">
                <h3 class="simulation-title">Simulasi Otomatis</h3>
                <div class="simulation-buttons">
                    <button class="btn auto-simulate-btn" onclick="simulateQuiz()">
                        <i class="fas fa-robot"></i> Simulasi Kuis Matematika
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variabel global
        let websocket;
        let currentScreen = 'main';
        let playerRole = null;
        let tictactoeBoard = ['', '', '', '', '', '', '', '', ''];
        let winPatterns = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // Baris
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // Kolom
            [0, 4, 8], [2, 4, 6]             // Diagonal
        ];
        
        // Variabel untuk kuis matematika
        let quizDifficulty = 'mudah';
        let quizTimeLimit = 3;
        let quizTimer;
        let timeLeft;
        let currentQuestion = '';
        let currentAnswer = 0;
        let userAnswer = 0;
        let robotAnswer = 0;
        let isQuizActive = false;
        let isSimulationMode = false;
        let gameActive = false;
        let userAnswered = false;
        let robotAnswered = false;
        let userAnswerCorrect = false;
        let robotAnswerCorrect = false;


        // Inisialisasi
        window.onload = function() {
            initTicTacToe();
            updateConnectionStatus(false);
        };
        
        // Fungsi koneksi WebSocket
        function connectWebSocket() {
            const ipAddress = document.getElementById('ipAddress').value;
            if (!ipAddress) {
                alert('Masukkan alamat IP ESP32 terlebih dahulu!');
                return;
            }
            
            const wsAddress = `ws://${ipAddress}:81/`;
            
            try {
                if (websocket) {
                    websocket.close();
                }
                
                websocket = new WebSocket(wsAddress);
                
                websocket.onopen = function() {
                    console.log("WebSocket connected");
                    updateConnectionStatus(true);
                };
                
                websocket.onclose = function() {
                    console.log("WebSocket disconnected");
                    updateConnectionStatus(false);
                };
                
                websocket.onmessage = function(event) {
                    handleMessage(event.data);
                };
                
                websocket.onerror = function(error) {
                    console.error("WebSocket error:", error);
                    updateConnectionStatus(false);
                };
            } catch (error) {
                console.error("WebSocket initialization error:", error);
                updateConnectionStatus(false);
            }
        }
        
        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
            }
            updateConnectionStatus(false);
        }
        
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (connected) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = 'Terhubung';
            } else {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'Terputus';
            }
        }
        
        // Handle pesan dari ESP32
        function handleMessage(message) {
            console.log("Received:", message);
            
            // Parsing pesan
            const parts = message.split(' ');
            const command = parts[0];
            
            switch(currentScreen) {
                case 'tictactoe':
                    handleTicTacToeMessage(command, parts);
                    break;
                case 'rps':
                    handleRPSMessage(command, parts);
                    break;
                case 'quiz':
                    handleQuizMessage(command, parts);
                    break;
            }
        }
        
        // Simulasi otomatis
        function simulateTicTacToe() {
            isSimulationMode = true;
            if (!playerRole) {
                setPlayerRole('X');
            }
            
            // Reset papan
            resetTicTacToe();
            gameActive = true;
            
            document.getElementById('tictactoeMessage').textContent = 'Simulasi dimulai! Giliran Anda.';
        }
        
        function simulateRPS() {
            isSimulationMode = true;
            document.getElementById('rpsMessage').textContent = 'Simulasi dimulai! Pilih salah satu.';
            document.getElementById('playerChoiceIcon').textContent = '-';
            document.getElementById('playerChoiceText').textContent = 'Belum memilih';
            document.getElementById('robotChoiceIcon').textContent = '-';
            document.getElementById('robotChoiceText').textContent = 'Belum memilih';
            
            playerChoice = null;
            robotChoice = null;
        }
        
        function simulateQuiz() {
            isSimulationMode = true;
            document.getElementById('quizMessage').textContent = 'Simulasi dimulai! Tekan Play untuk memulai.';
        }
        
        // Kirim pesan ke ESP32
        function sendMessage(message) {
            if (!isSimulationMode && websocket && websocket.readyState === WebSocket.OPEN) {
                console.log("Sent:", message);
                websocket.send(message);
            } else if (!isSimulationMode) {
                console.warn("WebSocket is not connected. Simulating: " + message);
            }
        }
        
        // Navigasi antar layar
        function loadGame(game) {
            document.getElementById(currentScreen + 'Screen').classList.add('hidden');
            document.getElementById(game + 'Screen').classList.remove('hidden');
            currentScreen = game;
            isSimulationMode = false;
            
            // Reset state game saat berpindah
            if (game === 'quiz') {
                resetQuiz();
            }
        }
        
        function backToMain() {
            document.getElementById(currentScreen + 'Screen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            currentScreen = 'main';
            isSimulationMode = false;
            gameActive = false;
            
            // Hentikan timer jika ada
            if (quizTimer) {
                clearInterval(quizTimer);
            }
        }
        
        // ===== TIC TAC TOE =====
        function initTicTacToe() {
            const board = document.getElementById('tictactoeBoard');
            board.innerHTML = '';
            
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'tictactoe-cell';
                cell.dataset.index = i;
                cell.onclick = () => selectTicTacToeCell(i);
                board.appendChild(cell);
            }
        }
        
        function setPlayerRole(role) {
            playerRole = role;
            const robotRole = role === 'X' ? 'O' : 'X';
            document.getElementById('tictactoeMessage').textContent = 
                `Anda ${role}, Robot ${robotRole}`;
            
            // Kirim peran ke ESP32
            if (!isSimulationMode) {
                sendMessage(`Kamu ${robotRole}`);
            }
        }
        
        function playTicTacToe() {
            isSimulationMode = false;
            if (!playerRole) {
                alert('Pilih peran Anda terlebih dahulu!');
                return;
            }
            
            // Reset papan
            resetTicTacToe();
            gameActive = true;
            
            // Kirim perintah play ke ESP32
            sendMessage('play XOX');
            
            // Jika robot mulai duluan
            if (playerRole === 'O') {
                document.getElementById('tictactoeMessage').textContent = 'Tunggu langkah robot...';
            } else {
                document.getElementById('tictactoeMessage').textContent = 'Giliran Anda!';
            }
        }
        
        function resetTicTacToe() {
            tictactoeBoard = ['', '', '', '', '', '', '', '', ''];
            const cells = document.querySelectorAll('.tictactoe-cell');
            cells.forEach(cell => {
                cell.textContent = '';
                cell.classList.remove('x', 'o');
            });
            document.getElementById('winLine').innerHTML = '';
            document.getElementById('tictactoeMessage').textContent = 'Permainan dimulai!';
            gameActive = true;
        }
        
        function selectTicTacToeCell(index) {
            if (tictactoeBoard[index] !== '' || !playerRole || !gameActive) return;
            
            // Set sel dengan peran pemain
            tictactoeBoard[index] = playerRole;
            const cells = document.querySelectorAll('.tictactoe-cell');
            cells[index].textContent = playerRole;
            cells[index].classList.add(playerRole.toLowerCase());
            
            // Kirim langkah ke ESP32 (index + 1 karena ESP32 menghitung dari 1)
            if (!isSimulationMode) {
                sendMessage((index + 1).toString());
            }
            
            // Cek kemenangan
            const winPattern = checkWin(tictactoeBoard, playerRole);
            if (winPattern) {
                document.getElementById('tictactoeMessage').textContent = 'Anda menang!';
                if (!isSimulationMode) {
                    sendMessage('robot kalah');
                }
                drawWinLine(winPattern);
                gameActive = false;
                return;
            }
            
            // Cek seri
            if (tictactoeBoard.every(cell => cell !== '')) {
                document.getElementById('tictactoeMessage').textContent = 'Seri!';
                if (!isSimulationMode) {
                    sendMessage('seri');
                }
                gameActive = false;
                return;
            }
            
            if (isSimulationMode) {
                // Simulasi: giliran robot
                document.getElementById('tictactoeMessage').textContent = 'Giliran robot...';
                
                setTimeout(() => {
                    const robotRole = playerRole === 'X' ? 'O' : 'X';
                    const availableMoves = [];
                    for (let i = 0; i < 9; i++) {
                        if (tictactoeBoard[i] === '') {
                            availableMoves.push(i);
                        }
                    }
                    
                    if (availableMoves.length > 0) {
                        const randomMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                        
                        tictactoeBoard[randomMove] = robotRole;
                        const cells = document.querySelectorAll('.tictactoe-cell');
                        cells[randomMove].textContent = robotRole;
                        cells[randomMove].classList.add(robotRole.toLowerCase());
                        
                        // Cek kemenangan robot
                        const robotWinPattern = checkWin(tictactoeBoard, robotRole);
                        if (robotWinPattern) {
                            document.getElementById('tictactoeMessage').textContent = 'Robot menang!';
                            drawWinLine(robotWinPattern);
                            gameActive = false;
                            return;
                        }
                        
                        // Cek seri
                        if (tictactoeBoard.every(cell => cell !== '')) {
                            document.getElementById('tictactoeMessage').textContent = 'Seri!';
                            gameActive = false;
                            return;
                        }
                        
                        document.getElementById('tictactoeMessage').textContent = 'Giliran Anda!';
                    }
                }, 1000);
            } else {
                document.getElementById('tictactoeMessage').textContent = 'Tunggu langkah robot...';
            }
        }
        
        function handleTicTacToeMessage(command, parts) {
            if (!gameActive) return;
            
            if (!isNaN(command)) {
                // Pesan berisi angka (langkah robot)
                const index = parseInt(command) - 1;
                const robotRole = playerRole === 'X' ? 'O' : 'X';
                
                // Set sel dengan peran robot
                tictactoeBoard[index] = robotRole;
                const cells = document.querySelectorAll('.tictactoe-cell');
                cells[index].textContent = robotRole;
                cells[index].classList.add(robotRole.toLowerCase());
                
                // Cek kemenangan
                const winPattern = checkWin(tictactoeBoard, robotRole);
                if (winPattern) {
                    document.getElementById('tictactoeMessage').textContent = 'Robot menang!';
                    sendMessage('robot menang');
                    drawWinLine(winPattern);
                    gameActive = false;
                    return;
                }
                
                // Cek seri
                if (tictactoeBoard.every(cell => cell !== '')) {
                    document.getElementById('tictactoeMessage').textContent = 'Seri!';
                    sendMessage('seri');
                    gameActive = false;
                    return;
                }
                
                document.getElementById('tictactoeMessage').textContent = 'Giliran Anda!';
            } else if (command === 'robot' && parts[1] === 'menang') {
                document.getElementById('tictactoeMessage').textContent = 'Robot menang!';
                gameActive = false;
            } else if (command === 'robot' && parts[1] === 'kalah') {
                document.getElementById('tictactoeMessage').textContent = 'Anda menang!';
                gameActive = false;
            } else if (command === 'seri') {
                document.getElementById('tictactoeMessage').textContent = 'Seri!';
                gameActive = false;
            }
        }
        
        function checkWin(board, player) {
            for (const pattern of winPatterns) {
                if (pattern.every(index => board[index] === player)) {
                    return pattern;
                }
            }
            return null;
        }
        
        function drawWinLine(pattern) {
            if (!pattern) return;
            
            const winLine = document.getElementById('winLine');
            winLine.innerHTML = '';
            
            const boardRect = document.getElementById('tictactoeBoard').getBoundingClientRect();
            const cellSize = boardRect.width / 3;
            
            const firstCell = document.querySelectorAll('.tictactoe-cell')[pattern[0]];
            const lastCell = document.querySelectorAll('.tictactoe-cell')[pattern[2]];
            
            const firstRect = firstCell.getBoundingClientRect();
            const lastRect = lastCell.getBoundingClientRect();
            
            const startX = firstRect.left + firstRect.width/2 - boardRect.left;
            const startY = firstRect.top + firstRect.height/2 - boardRect.top;
            const endX = lastRect.left + lastRect.width/2 - boardRect.left;
            const endY = lastRect.top + lastRect.height/2 - boardRect.top;
            
            const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
            
            const line = document.createElement('div');
            line.className = 'win-line';
            line.style.width = length + 'px';
            line.style.height = '8px';
            line.style.left = startX + 'px';
            line.style.top = startY + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            line.style.transformOrigin = '0 0';
            
            winLine.appendChild(line);
        }
        
        // ===== KERTAS BATU GUNTING =====
        let rpsTimer;
        let rpsTimeLeft = 3;
        let playerChoice = null;
        let robotChoice = null;
        
        function playRPS() {
            isSimulationMode = false;
            document.getElementById('rpsMessage').textContent = 'Pilih dalam 3 detik!';
            document.getElementById('playerChoiceIcon').textContent = '-';
            document.getElementById('playerChoiceText').textContent = 'Belum memilih';
            document.getElementById('robotChoiceIcon').textContent = '-';
            document.getElementById('robotChoiceText').textContent = 'Belum memilih';
            
            playerChoice = null;
            robotChoice = null;
            rpsTimeLeft = 3;
            
            // Kirim perintah play ke ESP32
            sendMessage('play kertas batu gunting');
            // Mulai timer
            clearInterval(rpsTimer);
            rpsTimer = setInterval(updateRPSTimer, 1000);
            updateRPSTimer();
        }
        
        function updateRPSTimer() {
            document.getElementById('rpsTimer').textContent = rpsTimeLeft;
            
            if (rpsTimeLeft <= 0) {
                clearInterval(rpsTimer);
                
                if (playerChoice === null) {
                    // Pemain tidak memilih, kalah
                    document.getElementById('rpsMessage').textContent = 'Waktu habis! Anda kalah.';
                    if (!isSimulationMode) {
                        sendMessage('Kamu kalah');
                    }
                } else {
                    // Pemain sudah memilih, tunggu jawaban robot
                    document.getElementById('rpsMessage').textContent = 'Menunggu robot...';
                }
            } else {
                rpsTimeLeft--;
            }
        }
        
        function selectRPS(choice) {
            if ((rpsTimeLeft <= 0 && !isSimulationMode) || (isSimulationMode && playerChoice !== null)) return;
            
            playerChoice = choice;
            let choiceText, choiceIcon;
            
            switch(choice) {
                case 1:
                    choiceText = 'Kertas';
                    choiceIcon = '📄';
                    break;
                case 2:
                    choiceText = 'Batu';
                    choiceIcon = '✊';
                    break;
                case 3:
                    choiceText = 'Gunting';
                    choiceIcon = '✂️';
                    break;
            }
            
            document.getElementById('playerChoiceIcon').textContent = choiceIcon;
            document.getElementById('playerChoiceText').textContent = choiceText;
            document.getElementById('rpsMessage').textContent = `Anda memilih: ${choiceText}`;
            
            // Kirim pilihan ke ESP32
            if (!isSimulationMode) {
                sendMessage(choice.toString());
                // Hentikan timer
                clearInterval(rpsTimer);
                document.getElementById('rpsTimer').textContent = '0';
            } else {
                // Simulasi: robot memilih secara acak
                setTimeout(() => {
                    const choices = [1, 2, 3];
                    robotChoice = choices[Math.floor(Math.random() * 3)];
                    
                    let robotChoiceText, robotChoiceIcon;
                    
                    switch(robotChoice) {
                        case 1:
                            robotChoiceText = 'Kertas';
                            robotChoiceIcon = '📄';
                            break;
                        case 2:
                            robotChoiceText = 'Batu';
                            robotChoiceIcon = '✊';
                            break;
                        case 3:
                            robotChoiceText = 'Gunting';
                            robotChoiceIcon = '✂️';
                            break;
                    }
                    
                    document.getElementById('robotChoiceIcon').textContent = robotChoiceIcon;
                    document.getElementById('robotChoiceText').textContent = robotChoiceText;
                    
                    // Tentukan pemenang
                    let result = determineRPSWinner(playerChoice, robotChoice);
                    
                    // Tampilkan hasil
                    if (result === 'win') {
                        document.getElementById('rpsMessage').textContent = 
                            `Anda menang! ${choiceText} mengalahkan ${robotChoiceText}`;
                    } else if (result === 'lose') {
                        document.getElementById('rpsMessage').textContent = 
                            `Anda kalah! ${robotChoiceText} mengalahkan ${choiceText}`;
                    } else {
                        document.getElementById('rpsMessage').textContent = 
                            `Seri! Keduanya memilih ${choiceText}`;
                    }
                }, 1000);
            }
        }
        
        function handleRPSMessage(command, parts) {
            if (!isNaN(command)) {
                // Pesan berisi angka (pilihan robot)
                robotChoice = parseInt(command);
                let choiceText, choiceIcon;
                
                switch(robotChoice) {
                    case 1:
                        choiceText = 'Kertas';
                        choiceIcon = '📄';
                        break;
                    case 2:
                        choiceText = 'Batu';
                        choiceIcon = '✊';
                        break;
                    case 3:
                        choiceText = 'Gunting';
                        choiceIcon = '✂️';
                        break;
                }
                
                document.getElementById('robotChoiceIcon').textContent = choiceIcon;
                document.getElementById('robotChoiceText').textContent = choiceText;
                
                // Tentukan pemenang
                let result = determineRPSWinner(playerChoice, robotChoice);
                
                // Tampilkan hasil
                if (result === 'win') {
                    document.getElementById('rpsMessage').textContent = 
                        `Anda menang! Robot memilih: ${choiceText}`;
                    sendMessage('Kamu menang');
                } else if (result === 'lose') {
                    document.getElementById('rpsMessage').textContent = 
                        `Anda kalah! Robot memilih: ${choiceText}`;
                    sendMessage('Kamu kalah');
                } else {
                    document.getElementById('rpsMessage').textContent = 
                        `Seri! Robot juga memilih: ${choiceText}`;
                    sendMessage('Kita seri');
                }
            }
        }
        
        function determineRPSWinner(player, robot) {
            if (player === robot) return 'draw';
            
            if (
                (player === 1 && robot === 3) || // Kertas vs Gunting -> Kalah
                (player === 2 && robot === 1) || // Batu vs Kertas -> Kalah
                (player === 3 && robot === 2)    // Gunting vs Batu -> Kalah
            ) {
                return 'lose';
            }
            
            return 'win';
        }
        
        function processQuizResult() {
    if (!isQuizActive) return;
    
    isQuizActive = false;
    clearInterval(quizTimer);
    
    // Tampilkan status jawaban robot jika sudah jawab
    if (robotAnswered) {
        const robotStatus = robotAnswerCorrect ? " ✓" : " ✗";
        document.getElementById('robotAnswer').textContent = robotAnswer + robotStatus;
    }
    
    // Tentukan hasil berdasarkan kondisi
    if (!userAnswered && !robotAnswered) {
        // Keduanya tidak jawab (waktu habis)
        document.getElementById('quizResult').textContent = 'Waktu Habis!';
        document.getElementById('quizResult').className = 'result-value incorrect';
        if (!isSimulationMode) {
            sendMessage('kita seri');
        }
    }
    else if (userAnswerCorrect && robotAnswerCorrect) {
        // Keduanya benar -> seri
        document.getElementById('quizResult').textContent = 'Seri! Keduanya Benar';
        document.getElementById('quizResult').className = 'result-value';
        if (!isSimulationMode) {
            sendMessage('kita seri');
        }
    }
    else if (!userAnswerCorrect && !robotAnswerCorrect) {
        // Keduanya salah -> seri
        document.getElementById('quizResult').textContent = 'Seri! Keduanya Salah';
        document.getElementById('quizResult').className = 'result-value incorrect';
        if (!isSimulationMode) {
            sendMessage('kita seri');
        }
    }
    else if (userAnswerCorrect && !robotAnswerCorrect) {
        // User benar, robot salah -> user menang
        document.getElementById('quizResult').textContent = 'Anda Menang!';
        document.getElementById('quizResult').className = 'result-value correct';
        if (!isSimulationMode) {
            sendMessage('kamu kalah');
        }
    }
    else if (!userAnswerCorrect && robotAnswerCorrect) {
        // User salah, robot benar -> robot menang
        document.getElementById('quizResult').textContent = 'Robot Menang!';
        document.getElementById('quizResult').className = 'result-value incorrect';
        if (!isSimulationMode) {
            sendMessage('kamu menang');
        }
    }
    else if (!userAnswered && robotAnswerCorrect) {
        // User tidak jawab, robot benar -> robot menang
        document.getElementById('quizResult').textContent = 'Robot Menang!';
        document.getElementById('quizResult').className = 'result-value incorrect';
        if (!isSimulationMode) {
            sendMessage('kamu menang');
        }
    }
    else if (userAnswerCorrect && !robotAnswered) {
        // User benar, robot tidak jawab -> user menang
        document.getElementById('quizResult').textContent = 'Anda Menang!';
        document.getElementById('quizResult').className = 'result-value correct';
        if (!isSimulationMode) {
            sendMessage('kamu kalah');
        }
    }
}
        
        // ===== KUIS MATEMATIKA =====
        function setDifficulty(difficulty) {
            quizDifficulty = difficulty;
            
            // Update tombol yang aktif
            document.getElementById('easyBtn').classList.remove('btn-success', 'btn-secondary');
            document.getElementById('mediumBtn').classList.remove('btn-warning', 'btn-secondary');
            document.getElementById('hardBtn').classList.remove('btn-danger', 'btn-secondary');
            
            if (difficulty === 'mudah') {
                document.getElementById('easyBtn').classList.add('btn-success');
                document.getElementById('mediumBtn').classList.add('btn-secondary');
                document.getElementById('hardBtn').classList.add('btn-secondary');
                quizTimeLimit = 3;
            } else if (difficulty === 'sedang') {
                document.getElementById('easyBtn').classList.add('btn-secondary');
                document.getElementById('mediumBtn').classList.add('btn-warning');
                document.getElementById('hardBtn').classList.add('btn-secondary');
                quizTimeLimit = 5;
            } else {
                document.getElementById('easyBtn').classList.add('btn-secondary');
                document.getElementById('mediumBtn').classList.add('btn-secondary');
                document.getElementById('hardBtn').classList.add('btn-danger');
                quizTimeLimit = 8;
            }
            
            document.getElementById('quizMessage').textContent = `Tingkat kesulitan: ${difficulty} (${quizTimeLimit} detik)`;
        }
        
        function resetQuiz() {
    isQuizActive = false;
    userAnswered = false;
    robotAnswered = false;
    userAnswerCorrect = false;
    robotAnswerCorrect = false;
    
    document.getElementById('questionDisplay').textContent = 'Soal akan muncul di sini';
    document.getElementById('quizTimer').textContent = '-';
    document.getElementById('robotAnswer').textContent = '-';
    document.getElementById('quizResult').textContent = '-';
    document.getElementById('quizResult').className = 'result-value';
    document.getElementById('quizMessage').textContent = 'Pilih tingkat kesulitan dan tekan Play';
    clearAnswer();
    
    // Hentikan timer jika ada
    if (quizTimer) {
        clearInterval(quizTimer);
    }
}
 function playQuiz() {
    isQuizActive = true;
    userAnswered = false;
    robotAnswered = false;
    userAnswerCorrect = false;
    robotAnswerCorrect = false;
    
    document.getElementById('robotAnswer').textContent = '-';
    document.getElementById('quizResult').textContent = '-';
    document.getElementById('quizResult').className = 'result-value';
    clearAnswer();
    
    // Kirim perintah play ke ESP32
    if (!isSimulationMode) {
        sendMessage('play quiz matematika');
    }
    
    // Generate pertanyaan
    generateQuestion();
    
    // Tampilkan pesan
    document.getElementById('quizMessage').textContent = `Pertanyaan ${quizDifficulty}, waktu: ${quizTimeLimit} detik`;
}
        
        function resetQuiz() {
    isQuizActive = false;
    userAnswered = false;
    robotAnswered = false;
    userAnswerCorrect = false;
    robotAnswerCorrect = false;
    
    document.getElementById('questionDisplay').textContent = 'Soal akan muncul di sini';
    document.getElementById('quizTimer').textContent = '-';
    document.getElementById('robotAnswer').textContent = '-';
    document.getElementById('quizResult').textContent = '-';
    document.getElementById('quizResult').className = 'result-value';
    document.getElementById('quizMessage').textContent = 'Pilih tingkat kesulitan dan tekan Play';
    clearAnswer();
    
    // Hentikan timer jika ada
    if (quizTimer) {
        clearInterval(quizTimer);
    }
}

        
        function generateQuestion() {
            let num1, num2, operator, operatorSymbol, operatorForESP;
            
            // Generate angka dan operator berdasarkan tingkat kesulitan
            if (quizDifficulty === 'mudah') {
                num1 = Math.floor(Math.random() * 10) + 1;
                num2 = Math.floor(Math.random() * 10) + 1;
                const operators = ['+', '-'];
                operator = operators[Math.floor(Math.random() * operators.length)];
            } else if (quizDifficulty === 'sedang') {
                num1 = Math.floor(Math.random() * 20) + 1;
                num2 = Math.floor(Math.random() * 10) + 1;
                const operators = ['+', '-', '*'];
                operator = operators[Math.floor(Math.random() * operators.length)];
            } else {
                num1 = Math.floor(Math.random() * 50) + 1;
                num2 = Math.floor(Math.random() * 10) + 1;
                const operators = ['+', '-', '*', '/'];
                operator = operators[Math.floor(Math.random() * operators.length)];
                
                // Untuk pembagian, pastikan hasilnya bilangan bulat
                if (operator === '/') {
                    num1 = num2 * (Math.floor(Math.random() * 10) + 1);
                }
            }
            
            // Tentukan simbol operator untuk tampilan dan untuk ESP32
            if (operator === '*') {
                operatorSymbol = '×';
                operatorForESP = '*';
            } else if (operator === '/') {
                operatorSymbol = '÷';
                operatorForESP = '/';
            } else {
                operatorSymbol = operator;
                operatorForESP = operator;
            }
            // Hitung jawaban yang benar
            switch(operator) {
                case '+':
                    currentAnswer = num1 + num2;
                    break;
                case '-':
                    currentAnswer = num1 - num2;
                    break;
                case '*':
                    currentAnswer = num1 * num2;
                    break;
                case '/':
                    currentAnswer = num1 / num2;
                    break;
            }
            
            // Format pertanyaan untuk tampilan
            currentQuestion = `${num1} ${operatorSymbol} ${num2} = `;
             // Kirim pertanyaan ke ESP32 (dalam format yang dapat diproses)
            if (!isSimulationMode) {
                sendMessage(`${num1} ${operatorForESP} ${num2}`);
            }
            
            // Tampilkan pertanyaan dengan animasi ketik
            typeQuestion(currentQuestion);
        }
        
        function typeQuestion(question) {
            const questionDisplay = document.getElementById('questionDisplay');
            questionDisplay.textContent = '';
            
            let i = 0;
            const typingInterval = setInterval(() => {
                if (i < question.length) {
                    questionDisplay.textContent += question.charAt(i);
                    i++;
                } else {
                    clearInterval(typingInterval);
                    
                    // Setelah pertanyaan selesai ditampilkan, mulai timer
                    startQuizTimer();
                    
                    // Jika mode simulasi, buat robot menjawab
                    if (isSimulationMode) {
                        simulateRobotAnswer();
                    }
                }
            }, 100); // Kecepatan mengetik (ms)
        }
        
        function startQuizTimer() {
    timeLeft = quizTimeLimit;
    document.getElementById('quizTimer').textContent = timeLeft;
    
    if (quizTimer) {
        clearInterval(quizTimer);
    }
    
    quizTimer = setInterval(() => {
        timeLeft--;
        document.getElementById('quizTimer').textContent = timeLeft;
        
        if (timeLeft <= 0) {
            clearInterval(quizTimer);
            
            // Jika belum ada yang jawab benar saat waktu habis
            if (!userAnswered || !userAnswerCorrect) {
                processQuizResult();
            }
        }
    }, 1000);
}
        
        // Fungsi untuk input jawaban
        function appendNumber(number) {
            if (!isQuizActive) return;
            
            const answerDisplay = document.getElementById('answerDisplay');
            let currentValue = answerDisplay.textContent;
            
            if (currentValue === '0') {
                answerDisplay.textContent = number;
            } else if (currentValue === '-0') {
                answerDisplay.textContent = '-' + number;
            } else {
                answerDisplay.textContent += number;
            }
            
            userAnswer = parseInt(answerDisplay.textContent);
        }
        
        function clearAnswer() {
            const answerDisplay = document.getElementById('answerDisplay');
            answerDisplay.textContent = '0';
            userAnswer = 0;
        }
        
        function deleteLast() {
            if (!isQuizActive) return;
            
            const answerDisplay = document.getElementById('answerDisplay');
            let currentValue = answerDisplay.textContent;
            
            if (currentValue.length > 1) {
                answerDisplay.textContent = currentValue.slice(0, -1);
                if (answerDisplay.textContent === '-') {
                    answerDisplay.textContent = '0';
                }
            } else {
                answerDisplay.textContent = '0';
            }
            
            userAnswer = parseInt(answerDisplay.textContent);
        }
        
        function toggleNegative() {
            if (!isQuizActive) return;
            
            const answerDisplay = document.getElementById('answerDisplay');
            let currentValue = answerDisplay.textContent;
            
            if (currentValue.startsWith('-')) {
                answerDisplay.textContent = currentValue.substring(1);
            } else if (currentValue === '0') {
                answerDisplay.textContent = '-0';
            } else {
                answerDisplay.textContent = '-' + currentValue;
            }
            
            userAnswer = parseInt(answerDisplay.textContent);
        }
        
function submitAnswer() {
    if (!isQuizActive || userAnswered) return;
    
    userAnswered = true;
    
    // Periksa jawaban user
    userAnswerCorrect = userAnswer === currentAnswer;
    
    // Jika user benar, hentikan timer dan langsung proses hasil
    if (userAnswerCorrect) {
        clearInterval(quizTimer);
        processQuizResult();
    }
    // Jika user salah, tunggu robot atau timer habis
    else if (robotAnswered) {
        // Robot sudah jawab, langsung proses
        processQuizResult();
    }
    // Jika user salah dan robot belum jawab, biarkan timer lanjut
}
                
        
        function handleQuizMessage(command, parts) {
    if (!isQuizActive) return;
    
    if (!isNaN(command)) {
        // Pesan berisi angka (jawaban dari ESP32)
        robotAnswer = parseInt(command);
        robotAnswered = true;
        
        // Periksa jawaban robot
        robotAnswerCorrect = robotAnswer === currentAnswer;
        
        // Tampilkan jawaban robot dengan status
        const robotStatus = robotAnswerCorrect ? " ✓" : " ✗";
        document.getElementById('robotAnswer').textContent = robotAnswer + robotStatus;
        
        // Jika robot benar, hentikan timer dan proses hasil
        if (robotAnswerCorrect) {
            processQuizResult();
        }
        // Jika robot salah dan user sudah jawab, proses hasil
        else if (userAnswered) {
            processQuizResult();
        }
        // Jika robot salah dan user belum jawab, biarkan timer lanjut
    }
}

 function simulateRobotAnswer() {
    // Simulasi: robot menjawab dengan 50% benar dan 50% salah
    const isCorrect = Math.random() > 0.5;
    const responseDelay = Math.random() * (quizTimeLimit * 1000 * 0.8) + 500; // 0.5 - 80% dari waktu
    
    setTimeout(() => {
        if (!isQuizActive) return;
        
        robotAnswered = true;
        
        if (isCorrect) {
            robotAnswer = currentAnswer;
            robotAnswerCorrect = true;
        } else {
            // Buat jawaban salah
            robotAnswer = currentAnswer + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 5) + 1);
            robotAnswerCorrect = false;
        }
        
        // Tampilkan jawaban robot dengan status
        const robotStatus = robotAnswerCorrect ? " ✓" : " ✗";
        document.getElementById('robotAnswer').textContent = robotAnswer + robotStatus;
        
        // Jika robot benar atau user sudah jawab, proses hasil
        if (robotAnswerCorrect || userAnswered) {
            processQuizResult();
        }
        // Jika robot salah dan user belum jawab, biarkan timer lanjut
        
    }, responseDelay);
}       

    </script>
</body>
</html>
        